name: Build Dataset Inspector

on:
  push:
    branches: [main]
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      ref:
        description: "Ref (branch, tag, or sha) to build"
        required: false
        default: ""

permissions:
  contents: write

env:
  NODE_VERSION: 20

jobs:
  prepare:
    runs-on: ubuntu-24.04
    outputs:
      ref: ${{ steps.ref.outputs.ref }}
      is_tag: ${{ steps.ref.outputs.is_tag }}
      tag_name: ${{ steps.ref.outputs.tag_name }}
      release_id: ${{ steps.release_id.outputs.release_id }}
    steps:
      - name: Checkout (for tag detection)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}
          fetch-depth: 0

      - name: Resolve ref
        id: ref
        shell: bash
        run: |
          set -euo pipefail
          REF="${{ github.event.inputs.ref || github.ref }}"

          echo "ref=$REF" >> "$GITHUB_OUTPUT"
          TAG=""
          if [[ "$REF" == refs/tags/* ]]; then
            TAG="${REF#refs/tags/}"
          else
            TAG="$(git describe --tags --exact-match HEAD 2>/dev/null || true)"
          fi

          if [[ -n "$TAG" ]]; then
            echo "is_tag=true" >> "$GITHUB_OUTPUT"
            echo "tag_name=$TAG" >> "$GITHUB_OUTPUT"
          else
            echo "is_tag=false" >> "$GITHUB_OUTPUT"
            echo "tag_name=" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub Release (auto notes)
        id: release
        if: ${{ steps.ref.outputs.is_tag == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ref.outputs.tag_name }}
          generate_release_notes: true
          draft: false
          prerelease: false

      - name: Export release id
        id: release_id
        shell: bash
        run: |
          echo "release_id=${{ steps.release.outputs.id }}" >> "$GITHUB_OUTPUT"

  frontend:
    runs-on: ubuntu-24.04
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install deps
        run: npm ci

      - name: Disable Next.js telemetry
        run: npx next telemetry disable

      - name: Build frontend
        run: npm run build

      - name: Upload frontend dist
        uses: actions/upload-artifact@v4
        with:
          name: frontend-out
          path: out
          if-no-files-found: error

  build:
    runs-on: ${{ matrix.os }}
    needs: [prepare, frontend]
    concurrency:
      group: build-${{ matrix.os }}-${{ needs.prepare.outputs.ref }}
      cancel-in-progress: false
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-15
            label: macOS (Apple Silicon)
            args: "--target aarch64-apple-darwin --bundles app,dmg"
          - os: ubuntu-24.04
            label: Ubuntu
            args: "--bundles appimage,deb,rpm"
          - os: windows-latest
            label: Windows
            args: "--bundles msi"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.ref }}
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ contains(matrix.os, 'macos') && 'aarch64-apple-darwin' || '' }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            src-tauri -> target

      - name: Install system deps (Ubuntu)
        if: matrix.os == 'ubuntu-24.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install deps
        run: npm ci

      - name: Download frontend dist
        uses: actions/download-artifact@v4
        with:
          name: frontend-out
          path: out

      - name: Build (no release)
        if: ${{ needs.prepare.outputs.is_tag != 'true' }}
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_DEVELOPER_ID: ${{ secrets.APPLE_DEVELOPER_ID }}
        with:
          projectPath: .
          includeUpdaterJson: false
          args: ${{ matrix.args }} --config src-tauri/tauri.ci.build.conf.json

      - name: Build & Upload to Release
        if: ${{ needs.prepare.outputs.is_tag == 'true' }}
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_DEVELOPER_ID: ${{ secrets.APPLE_DEVELOPER_ID }}
        with:
          projectPath: .
          includeUpdaterJson: true
          releaseId: ${{ needs.prepare.outputs.release_id }}
          args: ${{ matrix.args }} --config src-tauri/tauri.ci.release.conf.json
